<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Upload com Barra de Progresso</title>
  <style>
    /* Estilo básico para a barra de progresso */
    #progressContainer {
      width: 100%;
      background: #eee;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      height: 25px;
      position: relative;
    }
    #progressBar {
      height: 100%;
      background: #4caf50;
      width: 0%;
      transition: width 0.3s ease;
    }
    #progressMessage {
      margin-top: 10px;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <h1>Upload de Fotos e Vídeos com Barra de Progresso</h1>
  <input type="file" name="files" id="fileInput" multiple>
  <button id="uploadBtn">Enviar Arquivos</button>
  
  <!-- Container da barra de progresso -->
  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>
  <!-- Mensagem abaixo da barra -->
  <div id="progressMessage"></div>

  <script>
    const uploadBtn = document.getElementById("uploadBtn");
    const fileInput = document.getElementById("fileInput");
    const progressBar = document.getElementById("progressBar");
    const progressMessage = document.getElementById("progressMessage");
    
    // Variáveis globais para controle da barra de progresso
    let totalActions = 0;      // Número total de ações (1 por foto, ou 1 por chunk de vídeo)
    let completedActions = 0;  // Ações já concluídas
    const chunkSize = 5 * 1024 * 1024; // 5MB por chunk para vídeos
    
    // Atualiza a barra de progresso e a mensagem
    function updateProgress(message) {
      const percent = (completedActions / totalActions) * 100;
      progressBar.style.width = percent + "%";
      progressMessage.innerText = message + " (" + Math.round(percent) + "%)";
    }
    
    // Função para upload de fotos (upload normal)
    async function uploadImage(file) {
      updateProgress(`Anexando imagem '${file.name}'`);
      
      const formData = new FormData();
      // Importante: o backend espera o campo "files"
      formData.append("files", file);
      
      try {
        const response = await fetch('https://2ckh7b03-3000.brs.devtunnels.ms/checkin/upload', {
          method: "POST",
          body: formData
        });
        const data = await response.json();
        console.log(`Foto ${file.name} enviada:`, data);
      } catch (error) {
        console.error(`Erro no upload da foto ${file.name}:`, error);
      } finally {
        completedActions++;
        updateProgress(`Imagem '${file.name}' enviada.`);
      }
    }
    
    // Função para upload de vídeos em chunks
    async function uploadVideoInChunks(file) {
      const totalChunks = Math.ceil(file.size / chunkSize);
      // Gera um ID único para o vídeo (para não misturar chunks de vídeos diferentes)
      const fileId = (crypto.randomUUID ? crypto.randomUUID() : Date.now().toString() + Math.random().toString(36).substring(2, 10));
      const originalName = file.name;
      
      for (let index = 0; index < totalChunks; index++) {
        updateProgress(`Anexando vídeo '${originalName}' (chunk ${index + 1} de ${totalChunks})`);
        const start = index * chunkSize;
        const end = Math.min(file.size, start + chunkSize);
        const chunk = file.slice(start, end);
        
        const formData = new FormData();
        formData.append("fileId", fileId);
        formData.append("chunkIndex", index);
        formData.append("totalChunks", totalChunks);
        formData.append("originalName", originalName);
        // Importante: o backend espera o campo "chunk" para vídeos
        formData.append("chunk", chunk);
        
        try {
          const response = await fetch('https://2ckh7b03-3000.brs.devtunnels.ms/checkin/upload-chunk', {
            method: "POST",
            body: formData
          });
          const data = await response.json();
          console.log(`Chunk ${index + 1} de ${totalChunks} do vídeo '${originalName}' enviado:`, data);
        } catch (error) {
          console.error(`Erro no envio do chunk ${index + 1} do vídeo '${originalName}':`, error);
          progressMessage.innerText = `Erro no envio do chunk ${index + 1} do vídeo '${originalName}'.`;
          return; // Se ocorrer erro, interrompe o upload deste vídeo
        } finally {
          completedActions++;
          updateProgress(`Vídeo '${originalName}' - chunk ${index + 1} enviado.`);
        }
      }
    }
    
    uploadBtn.addEventListener("click", () => {
      const files = fileInput.files;
      if (!files.length) {
        alert("Selecione ao menos um arquivo.");
        return;
      }
      
      // Calcula o total de ações: cada foto = 1 ação; para cada vídeo, 1 ação por chunk
      totalActions = 0;
      Array.from(files).forEach(file => {
        if (file.type.startsWith("video/")) {
          totalActions += Math.ceil(file.size / chunkSize);
        } else if (file.type.startsWith("image/")) {
          totalActions += 1;
        }
      });
      
      // Reinicia o progresso
      completedActions = 0;
      updateProgress("Iniciando upload...");
      
      // Inicia o upload de cada arquivo conforme seu tipo
      Array.from(files).forEach(file => {
        if (file.type.startsWith("video/")) {
          uploadVideoInChunks(file);
        } else if (file.type.startsWith("image/")) {
          uploadImage(file);
        } else {
          console.log(`Tipo não suportado: ${file.name}`);
        }
      });
    });
  </script>
</body>
</html>
